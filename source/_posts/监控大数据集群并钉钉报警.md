---
title: 监控大数据集群并钉钉报警
tags: [shell脚本]
categories: 脚本
date: 2019-07-07 17:27:43
---

```bash
#!/bin/bash
#个人测试：https://oapi.dingtalk.com/robot/send?access_token=da26636c287511a04ea3e57fdfd860439b2644ae50d0dee18311ab9c1c5a669b
#集群监控脚本
webhook='https://oapi.dingtalk.com/robot/send?access_token=da26636c287511a04ea3e57fdfd860439b2644ae50d0dee18311ab9c1c5a669b'
cluster='hadoop'

progressnameold01="HMaster
ResourceManager
Kafka
HRegionServer
ProdServerStart
CanalAdminApplication
DataNode
StandaloneSessionClusterEntrypoint
NameNode
JournalNode
QuorumPeerMain
DFSZKFailoverController
CanalLauncher
NodeManager"
progressnameold02="CanalLauncher
QuorumPeerMain
NameNode
NodeManager
JournalNode
DFSZKFailoverController
HRegionServer
StandaloneSessionClusterEntrypoint
DataNode
HMaster
Kafka"
progressnameold03="QuorumPeerMain
HRegionServer
Kafka
DataNode
CanalLauncher
NodeManager"

progressname01=`/opt/jdk1.8.0_221/bin/jps|egrep -v "(TaskManagerRunner)|(Jps)"|cut -d " " -f2`
progressname02=`ssh root@hadoop02 "/opt/jdk1.8.0_221/bin/jps|egrep -v '(TaskManagerRunner)|(Jps)'|cut -d ' ' -f2"`
progressname03=`ssh root@hadoop03 "/opt/jdk1.8.0_221/bin/jps|egrep -v '(TaskManagerRunner)|(Jps)'|cut -d ' ' -f2"`

progressNum01=`/opt/jdk1.8.0_221/bin/jps|egrep -v "(TaskManagerRunner)|(Jps)"|wc -l`
progressNum02=`ssh root@hadoop02 "/opt/jdk1.8.0_221/bin/jps|egrep -v '(TaskManagerRunner)|(Jps)'|wc -l"`
progressNum03=`ssh root@hadoop03 "/opt/jdk1.8.0_221/bin/jps|egrep -v '(TaskManagerRunner)|(Jps)'|wc -l"`

function SendMsgToDingding() {
    curl $webhook -H 'Content-Type: application/json' -d "
    {
        'msgtype': 'text',
        'text': {
            'content': '集群名称：$cluster\n告警信息：$1节点$2进程丢失\n'
        },
        'at': {
            'isAtAll': true
        }
    }"
}

progressNum(){
    if [ "$3" -gt "$2" ];then
		echo "$4" > /tmp/file1
		echo "$5" > /tmp/file2
		# 比较上面指定的进程，差集
		node=`sort -m <(sort /tmp/file1 | uniq) <(sort /tmp/file2 | uniq) <(sort /tmp/file2 | uniq) | uniq -u`
		SendMsgToDingding $1 $node
    fi
}

progressNum hadoop01 $progressNum01 14 "$progressnameold01" "$progressname01"
progressNum hadoop02 $progressNum02 11 "$progressnameold02" "$progressname02"
progressNum hadoop03 $progressNum03 6 "$progressnameold03" "$progressname03"
```

