---
title: 简单的日志收集脚本 
tags: [shell脚本]
categories: 脚本
date: 2020-03-27 10:27:43
---

# 介绍

用于收集服务日志，显示到web浏览器中，使用于单台服务器，只是简单的日志收集脚本。

该脚本是通过cgi-bin显示到web上，所有需要安装httpd服务，httpd服务天生支持cgi。

# 运行环境

## httpd 安装

```bash
yum -y install httpd
```

```bash
vim /etc/httpd/conf/httpd.conf
# 修改以下内容
```

```bash
# 监听端口
Listen 8888

# cgi脚本存放路径
    ScriptAlias /cgi-bin/ "/var/www/cgi-bin/"

# 访问cgi的权限设置
<Directory "/var/www/cgi-bin">
   AllowOverride None
   Options +ExecCGI
   Order allow,deny
   Allow from all
</Directory>
```

```bash
# 重启httpd
systemctl restart httpd

# 加入开机启动
systemctl enable httpd
```



## 脚本

把以下脚本保存到`httpd`指定的`cgi`目录下，命名为`shell`，该脚本功能是收集浏览器`url`参数，在服务器执行，用户权限是`apache`。

```bash
#!/bin/sh  
alias urldecode='sed "s@+@ @g;s@%@\\\\x@g" | xargs -0 printf "%b"'
echo -e "Content-type: text/plain\n"  
decoded_str=`echo $QUERY_STRING | urldecode`
echo -e "`$decoded_str` \n"
```

把以下脚本保存到`httpd`指定的`cgi`目录下，命名为`index.sh`，该脚本功能是收服务的指定日志，并展以自定义命名展现在浏览器上。

```bash
#!/bin/bash

# 当前服务器地址，其中shell为上面的脚本
link="http://192.168.10.134:8888/cgi-bin/shell?tail%20-500%20"
cat << AAA
Content-Type:text/html;charset=utf-8

<html>
<head>
# 定义超链接样式
<style type="text/css">
        a { text-decoration: none;color: black}
        a:hover { text-decoration:underline;color: blue}
　　    a:link { text-decoration: none;color: blue}
　　    a:active { text-decoration:blink; color: blue}
　　    a:visited { text-decoration: none;color: green}
        .url { margin-left: 90px;margin-top: 50px;font-family:"Microsoft YaHei",微软雅黑,"MicrosoftJhengHei",华文细黑,STHeiti,MingLiu;letter-spacing:1px;line-height: 28px;font-weight:bold; font-size:18px;}
</style>
<title>
b2blog
</title>
</head>
<body>
<pre>
AAA

# 查找日志并重名，超链接到日志
for i in `ls /data/app/*/log.log`
do
	z=`echo $i|cut -d '/' -f4`
	echo '<a href='$link$i' style="text-decoration:none;"><font size=8>'$z'</font></a>'
done

cat << AAA
<pre>
</body>
</html>
AAA
```

```bash
# 赋予执行权限
chmod +x /var/www/cgi-bin/*
```

```bash
# 浏览器访问
curl http://192.168.10.134:8888/cgi-bin/index.sh
```

