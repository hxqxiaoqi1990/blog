---
title: 记一次磁盘空间不足问题
tags: [disk]
categories: linux基础
date: 2020-07-07 16:27:43
---

# 问题

1. 使用df -ha查看/分区容量占满
2. 但使用du -sh /*却没有占用大的目录
3. lsof |grep delete也没有占用deleted状态的大容量进程
4. find / -type f -size +100M -exec ls -lh {} \;查找大文件，也没有找到
5. find / -name ".*" -exec ls -lh {} \;查找隐藏文件，也没有太大的
6. 重启服务器没有效果，依然显示磁盘空间不足

# 思路

去谷歌和百度查了大量相关的资料，没有效果，最后仔细区分了下du和df的区别，得到灵感。

df 从文件系统上获得磁盘信息。

du 计算文件数容量总和的到磁盘信息。

du基本确定是实际的磁盘容量占用，既然du显示磁盘比较空余，那肯定是df这边出问题。

df从文件系统获取磁盘信息，大概率文件系统信息错误，查看linux的文件系统，是xfs，查找xfs文件系统异常相关文档。

# 解决方案

```bash
# 安装xfs检查工具
yum -y install xfsdump xfsprogs-devel xfsprogs

# 检测/分区的碎片，显示的数据是50%左右，
xfs_db -c frag -r /dev/sda3

# 尝试使用修复整理碎片
xfs_fsr /dev/sda3
```


ps：如果是SSD或者PCIE的SSD盘，一般不需要碎片整理，整理多了反而影响寿命。
